{% extends 'admin/layout.html.twig' %}

{% block admin_content %}
    {% for label, msgs in app.flashes %}
        {% for m in msgs %}<div class="flash {{ label }}">{{ m }}</div>{% endfor %}
    {% endfor %}

    {% set prof = attribute(parent, 'profile') is defined ? parent.profile : null %}

    <h1 style="margin-bottom:8px">Dossier parent en attente</h1>
    <p class="muted">Vérifiez les informations puis validez ou refusez.</p>

    <div class="card" style="margin-bottom:16px">
        <div class="card-head"><b>Informations du parent</b></div>
        <div class="card-body">
            <div class="grid-2">
                <div>
                    <div class="muted">Nom</div>
                    <div><b>{{ prof ? prof.lastName : '—' }}</b></div>
                </div>
                <div>
                    <div class="muted">Prénom</div>
                    <div><b>{{ prof ? prof.firstName : '—' }}</b></div>
                </div>
                <div>
                    <div class="muted">Email</div>
                    <div>{{ parent.email }}</div>
                </div>
                <div>
                    <div class="muted">Téléphone</div>
                    <div>{{ prof and prof.phone ? prof.phone : '—' }}</div>
                </div>
                <div>
                    <div class="muted">Adresse</div>
                    <div>{{ prof and prof.address ? prof.address : '—' }}</div>
                </div>
                <div>
                    <div class="muted">Code postal</div>
                    <div>{{ prof and prof.postalCode ? prof.postalCode : '—' }}</div>
                </div>
                <div>
                    <div class="muted">Ville</div>
                    <div>{{ prof and prof.city ? prof.city : '—' }}</div>
                </div>
                <div>
                    <div class="muted">Lien avec l’enfant</div>
                    <div>{{ prof and prof.relation ? prof.relation : '—' }}</div>
                </div>
            </div>
        </div>
    </div>

    <form method="post" action="{{ path('admin_pending_decision', { id: parent.id }) }}">
        <input type="hidden" name="_token" value="{{ csrf_token(token_id) }}">

        <div class="card" style="margin-bottom:16px">
            <div class="card-head"><b>Enfants renseignés</b></div>
            <div class="card-body">
                {% if children is empty %}
                    <p class="muted" style="margin:0">Aucun enfant saisi par ce parent.</p>
                {% else %}
                    <p class="muted" style="margin-top:0;margin-bottom:8px">
                        Cochez les enfants à <b>valider</b>. Les enfants non cochés seront <b>supprimés</b> si vous validez le compte.
                    </p>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                            <tr><th style="width:1%">Valider</th><th>Nom prénom</th><th>Niveau</th><th>Naissance</th><th>Établissement</th><th>Notes</th></tr>
                            </thead>
                            <tbody>
                            {% for c in children %}
                                <tr>
                                    <td><input type="checkbox" name="approved_children[]" value="{{ c.id }}" {{ c.isApproved ? 'checked' }}></td>
                                    <td><b>{{ c.firstName }} {{ c.lastName }}</b></td>
                                    <td>{{ c.level ?: '—' }}</td>
                                    <td>{{ c.dob ? c.dob|date('d/m/Y') : '—' }}</td>
                                    <td>{{ c.school ?: '—' }}</td>
                                    <td>{{ c.notes ?: '—' }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="row" style="gap:10px">
            <button class="btn primary" type="submit" name="decision" value="approve">Valider le compte</button>
            <button class="btn danger"  type="submit" name="decision" value="reject"
                    onclick="return confirm('Refuser et supprimer ce parent et tous ses enfants ?')">
                Refuser (supprimer)
            </button>
            <a class="btn ghost" href="{{ path('admin_pending_list') }}">Retour à la liste</a>
        </div>
    </form>
{% endblock %}
