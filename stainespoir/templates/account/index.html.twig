{# templates/account/index.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}Mon compte ‚Äî Espace parent{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        /* --- Sorties pass√©es --- */
        .past-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:16px; }
        @media (max-width: 780px){ .past-grid{ grid-template-columns:1fr } }
        .past-card{ display:grid; grid-template-columns:160px 1fr; gap:14px; align-items:stretch; }
        .past-card.noimg{ grid-template-columns:1fr; }
        .past-card.noimg .pc-media{ display:none; }
        .pc-media{ border-radius:12px; overflow:hidden; background:#f3f4f6; }
        .pc-media img{ display:block; width:100%; height:auto; object-fit:cover; aspect-ratio:4/3; }
        @supports not (aspect-ratio: 1){
            .pc-media{ position:relative; height:0; padding-bottom:75%; }
            .pc-media img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
        }
        .pc-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px }
        .pc-date{ font-weight:600 }
        .pc-title{ margin:0 0 4px; font-size:1.05rem }
        .pc-loc{ margin-bottom:6px }
        .pc-desc{ margin:6px 0 8px }
        .pc-meta{ font-size:.9em }
        .badge{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #e5e7eb; font-size:.85em }
        .badge.ok{ background:#e8f8ee; color:#0a7a43; border-color:#b8e6c9 }
        .badge.no{ background:#feecec; color:#b42318; border-color:#f3b4b0 }
        .badge.warn{ background:#fff7e6; color:#a15c00; border-color:#ffd591 }
        .badge.ghost{ background:#f3f4f6; color:#6b7280; border-color:#e5e7eb }

        /* --- Calendrier & loader --- */
        .card.cal{ position:relative; }
        .cal-loader{
            position:absolute; inset:0; display:none;
            background: rgba(255,255,255,.7);
            align-items:center; justify-content:center; flex-direction:column; gap:8px; z-index:5;
        }
        .spinner{ width:28px; height:28px; border-radius:50%;
            border:3px solid #e5e7eb; border-top-color:#6A1B9A; animation: spin .85s linear infinite; }
        .ltxt{ font-size:13px; color:#6b7280 }
        @keyframes spin { to { transform: rotate(360deg); } }
        .card.cal.is-loading .cal-loader{ display:flex; }
        .card.cal.is-loading .cal-grid{ opacity:.6; filter:grayscale(.15); transition:opacity .2s; }
        .cal-head .btn[disabled]{ opacity:.45; pointer-events:none; }

        /* petit toast d‚Äôerreur */
        .cal-toast{
            position:absolute; right:10px; bottom:10px; background:#feecec; color:#b42318;
            border:1px solid #f3b4b0; padding:8px 10px; border-radius:8px; font-size:.9em; display:none;
        }
        .cal-toast.show{ display:block; }

        /* --- Assurance (onglet) --- */
        .assu-grid{ display:grid; grid-template-columns:1fr; gap:18px; }
        .assu-child{ padding:18px; border:1px solid #eee; border-radius:14px; box-shadow:0 10px 30px rgba(20,20,43,.06); }
        .assu-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
        .assu-pill{ display:inline-block; background:#f5ecff; color:#6A1B9A; padding:.35rem .7rem; border-radius:999px; font-weight:600; }
        .assu-two{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px; }
        @media (max-width:780px){ .assu-two{ grid-template-columns:1fr } }
        .assu-box{ border:1px dashed #ddd; border-radius:12px; padding:14px; }
        .assu-box h3{ margin:0 0 6px; font-size:16px; }
        .assu-cta{ display:flex; gap:10px; flex-wrap:wrap; }

        .btn.purple{ background:#6A1B9A; color:#fff; border:none; border-radius:10px; padding:10px 16px; font-weight:600; cursor:pointer; }
        .btn.ghost{ background:#f3f4f6; color:#111827; border:1px solid #e5e7eb; border-radius:10px; padding:10px 16px; font-weight:600; cursor:pointer; }

        /* Cards et layout */
        .card{background:#fff;border:1px solid #eee;border-radius:14px;box-shadow:0 10px 30px rgba(20,20,43,.06);padding:18px}
        .pill{display:inline-block;background:#f5ecff;color:#6A1B9A;padding:.35rem .7rem;border-radius:999px;font-weight:600}
        .lead{color:#4b5563}
        .mb-3{margin-bottom:1rem}
        .subcard{border:1px dashed #ddd;border-radius:12px;padding:16px}

        /* Boutons */
        .btn.purple{ background:#6A1B9A; color:#fff; border:none; border-radius:10px; padding:10px 16px; font-weight:600; cursor:pointer; }
        .btn.ghost{ background:#f8f9fb; color:#111827; border:1px solid #e5e7eb; border-radius:10px; padding:10px 16px; font-weight:600; cursor:pointer; }
        .btn.purple:disabled{opacity:.6;cursor:not-allowed}

        /* Dropzone */
        .dz{ border-radius:12px; background:#fbfbff; }
        .dz-area{
            display:flex; align-items:center; gap:12px; padding:12px;
            border:2px dashed #d8c7ee; border-radius:12px; background:#f7f3ff;
            cursor:pointer; transition:.2s;
        }
        .dz-area:hover{ background:#f3ecff }
        .dz-area.is-dragover{ background:#ede4ff; border-color:#6A1B9A }
        .dz-icon{ flex:0 0 40px; height:40px; display:grid; place-items:center; border-radius:10px; background:#6A1B9A; color:#fff; font-weight:700 }
        .dz-title{ font-weight:700; margin:0; }
        .dz-sub{ font-size:12px; color:#6b7280; margin-top:2px }
        .dz-meta{ display:none; margin-top:8px; font-size:13px; color:#4b5563 }
        .dz-meta.show{ display:block }
        .dz-error{ display:none; margin-top:8px; font-size:13px; color:#b42318; background:#feecec; border:1px solid #f3b4b0; padding:6px 8px; border-radius:8px }
        .dz-error.show{ display:block }
        .dz-actions{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap }
        .link { border:none; background:none; color:#6A1B9A; font-weight:700; cursor:pointer; padding:0 }

    </style>
{% endblock %}

{% block body %}
    <main class="account">
        <section class="account-hero">
            <div class="container hero-row">
                <div class="hero-left">
                    <span class="pill">üë®‚Äçüë©‚Äçüëß Espace parents</span>
                    <h1>Mon compte</h1>
                    <p class="lead">Suivez les <strong>pr√©sences</strong>, les <strong>sorties</strong> et vos <strong>messages</strong>.</p>
                </div>

                <aside class="hero-right">
                    <form method="get" action="{{ path('app_account') }}" class="row" style="gap:10px;align-items:center">
                        <label class="fgroup floating selectKid" style="min-width:260px">
                            <select name="enfant" onchange="this.form.submit()">
                                {% for k in kids %}
                                    <option value="{{ k.id }}" {{ k.id==current.id ? 'selected' }}>
                                        {{ k.firstName }} {{ k.lastName }} ‚Äî {{ k.level ?? '' }}
                                    </option>
                                {% endfor %}
                            </select>
                            <span>Enfant</span>
                        </label>
                        <input type="hidden" name="tab" value="{{ tab }}">
                        <noscript><button class="btn">Voir</button></noscript>
                    </form>

                    <div class="kpi-circles">
                        <div class="circle" style="--p: {{ data.presencePct30|default(0) }};" data-val="{{ data.presencePct30|default(0) }}">
                            <b>{{ data.presentCount30|default(0) }}</b>
                            <span>Pr√©sences</span>
                        </div>
                        <div class="circle" style="--p: {{ data.absencePct30|default(0) }};" data-val="{{ data.absencePct30|default(0) }}">
                            <b>{{ data.absentCount30|default(0) }}</b>
                            <span>Absences</span>
                        </div>
                        <div class="circle" style="--p: {{ data.signedRate|default(0) }};" data-val="{{ data.signedRate|default(0) }}">
                            <b>{{ data.signedCount|default(0) }}/{{ data.totalUpcoming|default(0) }}</b>
                            <span>Sorties</span>
                        </div>
                    </div>
                </aside>
            </div>
        </section>

        <section class="section tabs">
            <div class="container">
                <nav class="tabs-nav" aria-label="Sections">
                    <a class="{{ tab=='overview'  ? 'active' }}" href="{{ path('app_account', {enfant: current.id, tab:'overview'}) }}">Vue d‚Äôensemble</a>
                    <a class="{{ tab=='presences' ? 'active' }}" href="{{ path('app_account', {enfant: current.id, tab:'presences'}) }}">Pr√©sences</a>
                    <a class="{{ tab=='sorties'   ? 'active' }}" href="{{ path('app_account', {enfant: current.id, tab:'sorties'}) }}">Sorties</a>
                    <a class="{{ tab=='messages'  ? 'active' }}" href="{{ path('app_account', {enfant: current.id, tab:'messages'}) }}">Messages</a>
                    <a class="{{ tab=='settings'  ? 'active' }}" href="{{ path('app_account', {enfant: current.id, tab:'settings'}) }}">Param√®tres</a>
                    {# --- AJOUT : Onglet Assurance --- #}
                    <a class="{{ tab=='assurance' ? 'active' }}" href="{{ path('app_account', {enfant: current.id, tab:'assurance'}) }}">Assurance</a>
                </nav>
            </div>
        </section>

        <section class="section">
            <div class="container">

                {# ===== OVERVIEW ===== #}
                {% if tab == 'overview' %}
                    <div class="grid-3">
                        <article class="card">
                            <div class="card-head"><b>Prochaine s√©ance</b></div>
                            <p>Samedi prochain ‚Äî pr√©sence pr√©vue :
                                <span class="badge ghost">{{ (data.presenceRate30 ?? 0) >= 50 ? 'Plut√¥t pr√©sent' : 'Plut√¥t absent' }}</span>
                            </p>
                            <p class="muted">Maison des associations ‚Äî Stains</p>
                            <div class="actions" style="margin-top:10px">
                                <a class="btn ghost" href="{{ path('app_account', {enfant: current.id, tab:'assurance'}) }}">G√©rer les assurances</a>
                            </div>
                        </article>

                        <article class="card">
                            <div class="card-head"><b>Sorties √† venir</b></div>
                            <ul class="clean">
                                {% set up3 = data.upcomings|slice(0,3) %}
                                {% if up3 is not empty %}
                                    {% for r in up3 %}
                                        <li>{{ r.startsAt|date('d/m') }} ‚Äî {{ r.title }}</li>
                                    {% endfor %}
                                {% else %}
                                    <li class="muted">Aucune sortie programm√©e.</li>
                                {% endif %}
                            </ul>
                            <div class="actions">
                                <a class="btn ghost" href="{{ path('app_account', {enfant: current.id, tab:'sorties'}) }}">Voir les sorties</a>
                            </div>
                        </article>
                    </div>
                {% endif %}

                {# ===== PRESENCES ‚Äî calendrier (AJAX mois, sans reload) ===== #}
                {% if tab == 'presences' and data.cal %}
                    <div class="panel-head">
                        <h2>Pr√©sences ‚Äî Calendrier</h2>
                        <p class="muted">Lecture seule ‚Äî les statuts sont saisis par l‚Äô√©quipe Stains Espoir.</p>
                    </div>

                    <form method="get" action="{{ path('app_account') }}" class="row" style="gap:10px;align-items:center;margin-bottom:12px">
                        <input type="hidden" name="enfant" value="{{ current.id }}">
                        <input type="hidden" name="tab" value="presences">
                        <label class="fgroup floating">
                            {% set y = data.schoolYear %}
                            <select name="annee" id="schoolYear" onchange="this.form.submit()">
                                {% for yy in [y-1, y, y+1] %}
                                    <option value="{{ yy }}" {{ yy==y ? 'selected' }}>{{ yy }}‚Äì{{ yy+1 }}</option>
                                {% endfor %}
                            </select>
                            <span>Ann√©e scolaire</span>
                        </label>
                        <noscript><button class="btn">Aller</button></noscript>
                    </form>

                    <div id="presenceCal"
                         data-child="{{ current.id }}"
                         data-annee="{{ data.schoolYear }}"
                         data-month="{{ data.cal.monthKey }}"
                         data-endpoint="{{ path('app_account_presences_month') }}">

                        <div class="card cal" aria-live="polite" aria-busy="false">
                            <div class="cal-head" id="calHead">
                                {% if data.cal.prev %}
                                    <button type="button" class="btn cal-prev" data-month="{{ data.cal.prev }}" aria-label="Mois pr√©c√©dent">‚Üê</button>
                                {% else %}
                                    <button type="button" class="btn cal-prev" disabled aria-label="Mois pr√©c√©dent">‚Üê</button>
                                {% endif %}

                                <div class="cal-title" id="calTitle">{{ data.cal.label|capitalize }}</div>

                                {% if data.cal.next %}
                                    <button type="button" class="btn cal-next" data-month="{{ data.cal.next }}" aria-label="Mois suivant">‚Üí</button>
                                {% else %}
                                    <button type="button" class="btn cal-next" disabled aria-label="Mois suivant">‚Üí</button>
                                {% endif %}
                            </div>

                            <div class="cal-grid" id="calGrid" aria-label="Calendrier mensuel">
                                {% set dayNames = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'] %}
                                {% for name in dayNames %}
                                    <div class="cal-dayname">{{ name }}</div>
                                {% endfor %}

                                {% if data.cal.startPad > 0 %}
                                    {% for _ in 1..data.cal.startPad %}
                                        <div class="cal-cell empty"></div>
                                    {% endfor %}
                                {% endif %}

                                {% for d in data.cal.days %}
                                    <div class="cal-cell {{ d.isSaturday ? 'sat' }}">
                                        <div class="cal-num">{{ d.d }}</div>
                                        {% if d.isSaturday %}
                                            {% set st = d.status %}
                                            {% set label = st == 'present' ? 'Pr√©sent' : (st == 'absent' ? 'Absent' : (st in ['late','excused'] ? '√Ä confirmer' : '‚Äî')) %}
                                            {% set cls   = st == 'present' ? 'yes'     : (st == 'absent' ? 'no'     : (st in ['late','excused'] ? 'maybe'       : 'none')) %}
                                            <div class="cal-status {{ cls }}">{{ label }}</div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>

                            <div class="cal-loader" id="calLoader">
                                <div class="spinner" aria-hidden="true"></div>
                                <div class="ltxt">Chargement‚Ä¶</div>
                            </div>
                            <div class="cal-toast" id="calToast">Impossible de charger le mois. R√©essayez.</div>
                        </div>
                    </div>
                {% endif %}

                {# ===== SORTIES ===== #}
                {% if tab == 'sorties' %}
                    <div class="panel-head">
                        <h2>Sorties</h2>
                        <p class="muted">Toutes les sorties .</p>
                    </div>

                    <div class="out-grid">
                        {% if data.allOutings is empty %}
                            <p class="muted">Aucune sortie pour le moment.</p>
                        {% endif %}

                        {% set now = date() %} {# now = DateTime du serveur (timezone Symfony) #}

                        {% for o in data.allOutings %}
                            {# Invitation de cet enfant ? #}
                            {% set reg = data.invitedMap[o.id] ?? null %}
                            {% set signed = reg and (reg.signedAt or reg.status in ['confirmed','attended']) %}

                            {# Capacit√© et places restantes (globale, pas par enfant) #}
                            {% set cap = o.capacity %}
                            {% set signedCount = data.signedCounts[o.id] ?? 0 %}
                            {% set remaining = cap is not null ? (cap - signedCount) : null %}

                            {# Sortie pass√©e ? #}
                            {% set isPast = o.startsAt < now %}

                            <article class="out-ticket">
                                {% if o.imageUrl %}
                                    <img src="{{ o.imageUrl }}" alt="Image ‚Äî {{ o.title }}" class="ticket-cover">
                                {% endif %}

                                <div class="ribbon">{{ isPast ? 'Sortie pass√©e' : 'Sortie' }}</div>

                                <div class="t-head">
                                    <h3>
                                        {{ o.title }}
                                        {% if cap is not null and not isPast %}
                                            <small style="color: gray; font-weight: normal">
                                                ({{ remaining > 0 ? remaining : 0 }} place(s) disponible{{ remaining > 1 ? 's' : '' }})
                                            </small>
                                        {% endif %}
                                    </h3>
                                    <div class="t-date">{{ o.startsAt|date('d/m/Y') }}</div>
                                </div>

                                {% if o.location %}
                                    <div class="t-meta">{{ o.location }}</div>
                                {% endif %}


                                {% set plain = o.descriptionPlain %}
                                {% set excerpt = plain|length > 220
                                    ? (plain|u.truncate(220, '‚Ä¶', true))
                                    : plain
                                %}

                                <p class="pc-desc">
                                    {{ excerpt }} {# pas de raw n√©cessaire #}
                                    <a style="color: cornflowerblue"
                                       href="{{ path('outing_show', { id: o.id, slug: o.slug ?? '' }) }}"
                                       aria-label="Voir le d√©tail de la sortie ¬´ {{ o.title }} ¬ª">Voir plus</a>
                                </p>



                                <div class="out-actions">
                                    {% if reg %}
                                        {% if signed %}
                                            <span class="badge ok">Sign√©e</span>
                                            <a class="btn" href="{{ path('app_account_outing_pdf', { id: reg.id }) }}">T√©l√©charger l‚Äôattestation</a>
                                        {% else %}
                                            {% if isPast %}

                                            {% elseif cap is not null and remaining <= 0 %}
                                                <button class="btn" disabled>Sortie d√©j√† compl√®te</button>
                                                <small class="text-muted d-block mt-1">(0 place(s) disponible)</small>
                                            {% else %}
                                                <a class="btn ghost" href="{{ path('app_account_outing_sign_form', { id: reg.id }) }}">Autoriser la sortie</a>
                                                {% if cap is not null %}
                                                    <small class="text-muted d-block mt-1">
                                                        ({{ remaining }} place(s) disponible{{ remaining > 1 ? 's' : '' }})
                                                    </small>
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                {% endif %}


                {# ===== MESSAGES ===== #}
                {% if tab == 'messages' %}
                    {% for label, msgs in app.flashes %}
                        {% for m in msgs %}<div class="flash {{ label }}">{{ m }}</div>{% endfor %}
                    {% endfor %}

                    <div class="msg-layout">
                        <div id="msgList" class="card msg-list" style="max-height:420px;overflow:auto">
                            {% if data.messages is empty %}
                                <p class="muted" style="margin:0">Aucun message.</p>
                            {% else %}
                                {% for m in data.messages %}
                                    <div class="msg {{ m.from == 'staff' ? 'left' : 'right' }}">
                                        <div class="bubble">{{ m.body }}</div>
                                        <div class="when">
                                            {{ m.createdAt|date('d/m/Y H:i') }}{% if not m.readAt %} ¬∑ <span class="badge warn">Non lu</span>{% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <form class="card msg-compose" method="post" action="{{ path('app_account_message_send') }}">
                            <input type="hidden" name="_token" value="{{ csrf_token('send_message') }}">
                            <input type="hidden" name="child_id" value="{{ current.id }}">
                            <label class="fgroup floating wide">
                                <textarea name="text" rows="3" placeholder=" " required></textarea>
                                <span>Votre message‚Ä¶</span>
                            </label>
                            <div class="actions"><button class="btn" type="submit">Envoyer</button></div>
                        </form>
                    </div>
                {% endif %}

                {# ===== PARAMETRES ===== #}
                {% if tab == 'settings' %}
                    <div class="grid-2">
                        <div class="card">
                            <b>Profil parent</b>
                            <div class="grid-2">
                                <div><div class="muted">Pr√©nom</div><div><b>{{ app.user.profile.firstName }}</b></div></div>
                                <div><div class="muted">Nom</div><div><b>{{ app.user.profile.lastName }}</b></div></div>
                                <div><div class="muted">Email</div><div>{{ app.user.email }}</div></div>
                                <div><div class="muted">T√©l√©phone</div><div>{{ app.user.profile.phone }}</div></div>
                            </div>
                        </div>
                        <div class="card">
                            <b>Enfants rattach√©s</b>
                            <div class="kid-mini-list">
                                {% for k in kids %}
                                    <div class="kid-mini"><b>{{ k.firstName }} {{ k.lastName }}</b> ‚Äî {{ k.level ?? '' }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}


                {% if tab == 'assurance' %}

                    {% if insurance_forms is defined and insurance_existing is defined and current_school_year is defined %}

                        <h1>Assurances scolaires <small style="color:#667085;font-weight:500;">({{ current_year }})</small></h1>
                        <p class="lead mb-3">D√©posez pour chaque enfant : <strong>Responsabilit√© civile</strong>. Un administrateur validera ensuite.</p>


                        <div class="assu-grid">
                            {% for child in kids %}
                                <article class="assu-child">
                                    <div class="assu-head">
                                        <div>
                                            <span class="assu-pill">{{ child.firstName }} {{ child.lastName }}</span>
                                            <div class="muted" style="font-size:13px;margin-top:4px">Ann√©e scolaire : {{ current_school_year }}</div>
                                        </div>
                                    </div>

                                    <div class="assu-two">
                                        {% for t in ['RC','HEALTH'] %}
                                            <div class="assu-box">
                                                <h3>{% if t=='RC' %}Responsabilit√© civile{% else %}Assurance maladie{% endif %}</h3>

                                                {% set items = (insurance_existing[child.id] ?? [])|filter(i => i.type == t) %}
                                                {% set currentIns = (items|filter(i => i.schoolYear == current_school_year)|first) %}
                                                {% if currentIns %}
                                                    {% set s = currentIns.status %}
                                                    {% set label = s == 'APPROVED' ? 'Valid√©e' : (s == 'REJECTED' ? 'Refus√©e' : 'En attente') %}
                                                    {% set cls = s == 'APPROVED' ? 'ok' : (s == 'REJECTED' ? 'no' : 'warn') %}
                                                    <p style="margin:6px 0 10px 0;font-size:14px;">
                                                        Statut : <span class="badge {{ cls }}">{{ label }}</span>
                                                        {% if currentIns.path %}
                                                            ‚Äî <a href="{{ asset(currentIns.path) }}" target="_blank" rel="noopener">Voir le fichier</a>
                                                        {% endif %}
                                                        {% if currentIns.adminComment %}
                                                            <br><small class="muted">Commentaire admin : {{ currentIns.adminComment }}</small>
                                                        {% endif %}
                                                    </p>
                                                {% else %}
                                                    <p class="muted" style="margin:6px 0 10px 0;font-size:14px;">Aucun document d√©pos√© pour {{ current_school_year }}.</p>
                                                {% endif %}

                                                {# Formulaire d‚Äôupload unitaire (d√©j√† pr√©par√© cot√© contr√¥leur) #}
                                                {{ form_start(insurance_forms[child.id][t]) }}
                                                {{ form_row(insurance_forms[child.id][t].file) }}
                                                <button class="btn purple" type="submit">D√©poser / Remplacer</button>
                                                {{ form_end(insurance_forms[child.id][t]) }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </article>
                            {% endfor %}
                        </div>

                    {% else %}

                        {{ render(path('account_insurance_index')) }}

                    {% endif %}
                {% endif %}

            </div>
        </section>
    </main>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        (function(){
            function initCalendar(){
                const root = document.getElementById('presenceCal');
                if(!root) return;

                const endpoint = root.dataset.endpoint;
                const childId  = root.dataset.child;
                let   annee    = parseInt(root.dataset.annee || '0', 10) || new Date().getFullYear();

                const card    = root.querySelector('.card.cal');
                const titleEl = document.getElementById('calTitle');
                const grid    = document.getElementById('calGrid');
                const toast   = document.getElementById('calToast');

                function setLoading(v){
                    if (!card) return;
                    card.classList.toggle('is-loading', !!v);
                    card.setAttribute('aria-busy', v ? 'true' : 'false');
                }
                function showToast(msg){
                    if(!toast) return;
                    toast.textContent = msg || "Erreur.";
                    toast.classList.add('show');
                    setTimeout(()=>toast.classList.remove('show'), 2500);
                }

                async function loadMonth(monthKey){
                    if(!monthKey) return;
                    setLoading(true);
                    try{
                        const url = `${endpoint}?enfant=${encodeURIComponent(childId)}&annee=${encodeURIComponent(annee)}&mois=${encodeURIComponent(monthKey)}&_=${Date.now()}`;
                        const res = await fetch(url, {
                            headers: { 'X-Requested-With':'XMLHttpRequest', 'Accept':'application/json' },
                            credentials: 'same-origin'
                        });
                        if(!res.ok) throw new Error('HTTP '+res.status);
                        const data = await res.json();
                        if (data.error){ showToast(data.error); return; }

                        // MAJ titre + grille
                        if (titleEl && data.label) titleEl.textContent = data.label;
                        if (data.grid) grid.innerHTML = data.grid;

                        // MAJ boutons (prev/next) via d√©l√©gation (on ne remplace pas le head)
                        const prevBtn = root.querySelector('.cal-head .cal-prev');
                        const nextBtn = root.querySelector('.cal-head .cal-next');

                        if (prevBtn){
                            if (data.prev){ prevBtn.disabled = false; prevBtn.dataset.month = data.prev; }
                            else { prevBtn.disabled = true; prevBtn.removeAttribute('data-month'); }
                        }
                        if (nextBtn){
                            if (data.next){ nextBtn.disabled = false; nextBtn.dataset.month = data.next; }
                            else { nextBtn.disabled = true; nextBtn.removeAttribute('data-month'); }
                        }

                        // MAJ URL
                        const nu = new URL(window.location.href);
                        nu.searchParams.set('enfant', childId);
                        nu.searchParams.set('tab', 'presences');
                        nu.searchParams.set('annee', annee);
                        nu.searchParams.set('mois', data.monthKey || monthKey);
                        history.replaceState({}, '', nu);

                    } catch(err){
                        console.error(err);
                        showToast("Impossible de charger le mois.");
                    } finally {
                        setLoading(false);
                    }
                }

                // D√âL√âGATION: capte les clics sur les boutons prev/next m√™me si le DOM change
                root.addEventListener('click', function(e){
                    const btn = e.target.closest('.cal-head .cal-prev, .cal-head .cal-next');
                    if(!btn || btn.disabled) return;
                    const mk = btn.dataset.month;
                    if(!mk) return;
                    e.preventDefault();
                    e.stopPropagation();
                    loadMonth(mk);
                }, true); // capture

                // (Optionnel) changement d‚Äôann√©e sans reload :
                const selYear = document.getElementById('schoolYear');
                selYear?.addEventListener('change', () => {
                    annee = parseInt(selYear.value, 10) || annee;
                    loadMonth(`${annee}-09`);
                });
            }

            // Init fiable (classique + Turbo)
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initCalendar, { once:true });
            } else {
                initCalendar();
            }
            document.addEventListener('turbo:load', initCalendar);
        })();

        // Messages : scroll en bas par d√©faut
        (function(){ var box=document.getElementById('msgList'); if(box) box.scrollTop=box.scrollHeight; })();


        (function initDZ(){
            const ACCEPT = ['application/pdf','image/jpeg','image/png'];

            function fmtBytes(n){
                if(n===0) return '0 o';
                const u=['o','Ko','Mo','Go']; let i=0;
                while(n>=1024 && i<u.length-1){ n/=1024; i++; }
                return (Math.round(n*10)/10)+' '+u[i];
            }
            function validType(file){
                return ACCEPT.includes(file.type) || /\.(pdf|jpe?g|png)$/i.test(file.name);
            }

            function setupOne(dz){
                const inputId = dz.getAttribute('data-for');
                const input   = document.getElementById(inputId);
                const area    = dz.querySelector('.dz-area'); // label cliquable
                const meta    = dz.querySelector('.dz-meta');
                const errBox  = dz.querySelector('.dz-error');
                const clearBtn= dz.querySelector('.dz-clear');
                const form    = dz.closest('form.dz-form');
                const max     = parseInt(form?.dataset.max || (5*1024*1024), 10);

                if(!input || !meta || !errBox) return;

                function showErr(msg){
                    errBox.textContent = msg;
                    errBox.classList.add('show');
                    setTimeout(()=>errBox.classList.remove('show'), 4000);
                }
                function setFile(file){
                    if(!file) return;
                    if(!validType(file)){ showErr('Format non support√©. PDF, JPG ou PNG uniquement.'); input.value=''; meta.classList.remove('show'); clearBtn.hidden=true; return; }
                    if(file.size > max){ showErr('Le fichier d√©passe 5 Mo.'); input.value=''; meta.classList.remove('show'); clearBtn.hidden=true; return; }
                    meta.innerHTML = 'Fichier s√©lectionn√© : <b>'+ file.name + '</b> ('+ fmtBytes(file.size) +')';
                    meta.classList.add('show');
                    if(clearBtn) clearBtn.hidden = false;
                }

                // --- Drag & Drop sur le CONTAINER .dz (fiable)
                ['dragenter','dragover'].forEach(evt=>{
                    dz.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); area?.classList.add('is-dragover'); });
                });
                ['dragleave','dragend'].forEach(evt=>{
                    dz.addEventListener(evt, ()=>{ area?.classList.remove('is-dragover'); });
                });
                dz.addEventListener('drop', (e)=>{
                    e.preventDefault(); e.stopPropagation();
                    area?.classList.remove('is-dragover');
                    const file = e.dataTransfer?.files?.[0];
                    if(!file) return;
                    const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files;
                    setFile(file);
                    // Pour auto-envoyer au drop: form?.submit();
                });

                // --- S√©lection via dialogue
                input.addEventListener('change', ()=>{
                    const f = input.files?.[0];
                    if(f) setFile(f);
                });

                // --- Bouton "Retirer"
                clearBtn?.addEventListener('click', ()=>{
                    input.value=''; meta.classList.remove('show'); clearBtn.hidden=true;
                });

                // --- Garde-fous au submit (le serveur revalide quoiqu‚Äôil arrive)
                form?.addEventListener('submit', (e)=>{
                    const f = input.files?.[0];
                    if(!f){ showErr('Merci de s√©lectionner un fichier.'); e.preventDefault(); return; }
                    if(!validType(f) || f.size>max){ showErr('Fichier invalide.'); e.preventDefault(); }
                });
            }

            function boot(){
                // Emp√™che le navigateur d‚Äôouvrir le fichier si on drop en dehors
                ['dragover','drop'].forEach(evt=>{
                    window.addEventListener(evt, (e)=>{ e.preventDefault(); }, { passive:false });
                    document.body.addEventListener(evt, (e)=>{ e.preventDefault(); }, { passive:false });
                });
                document.querySelectorAll('.dz').forEach(setupOne);
            }

            if (document.readyState === 'loading'){
                document.addEventListener('DOMContentLoaded', boot, {once:true});
            } else {
                boot();
            }
            // Compatibilit√© Turbo (Hotwire / Symfony UX)
            document.addEventListener('turbo:load', boot);
        })();

    </script>
{% endblock %}
