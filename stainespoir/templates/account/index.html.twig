{% extends 'base.html.twig' %}
{% block title %}Mon compte ‚Äî Espace parent{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    <style>
        .past-grid{
            display:grid;
            grid-template-columns:repeat(2,minmax(0,1fr));
            gap:16px;
        }
        @media (max-width: 780px){ .past-grid{ grid-template-columns:1fr } }

        .past-card{
            display:grid;
            grid-template-columns:160px 1fr;
            gap:14px;
            align-items:stretch;
        }
        /* Sans image : passe en une seule colonne, corps full width */
        .past-card.noimg{
            grid-template-columns:1fr;
        }
        .past-card.noimg .pc-media{ display:none; }

        .pc-media{
            border-radius:12px; overflow:hidden; background:#f3f4f6;
        }
        .pc-media img{
            display:block; width:100%; height:auto; object-fit:cover; aspect-ratio: 4 / 3;
        }
        /* Fallback si aspect-ratio non support√© */
        @supports not (aspect-ratio: 1){
            .pc-media{ position:relative; height:0; padding-bottom:75%; }
            .pc-media img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
        }

        .pc-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px }
        .pc-date{ font-weight:600 }
        .pc-title{ margin:0 0 4px; font-size:1.05rem }
        .pc-loc{ margin-bottom:6px }
        .pc-desc{ margin:6px 0 8px }
        .pc-meta{ font-size:.9em }

        .badge{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #e5e7eb; font-size:.85em }
        .badge.ok{ background:#e8f8ee; color:#0a7a43; border-color:#b8e6c9 }
        .badge.no{ background:#feecec; color:#b42318; border-color:#f3b4b0 }
        .badge.warn{ background:#fff7e6; color:#a15c00; border-color:#ffd591 }
        .badge.ghost{ background:#f3f4f6; color:#6b7280; border-color:#e5e7eb }
    </style>
{% endblock %}


{% block body %}
    <main class="account">
        <section class="account-hero">
            <div class="container hero-row">
                <div class="hero-left">
                    <span class="pill">üë®‚Äçüë©‚Äçüëß Espace parents</span>
                    <h1>Mon compte</h1>
                    <p class="lead">Suivez les <strong>pr√©sences</strong>, les <strong>sorties</strong> et vos <strong>messages</strong>.</p>
                </div>

                <aside class="hero-right">
                    <form method="get" action="{{ path('app_account') }}" class="row" style="gap:10px;align-items:center">
                        <label class="fgroup floating selectKid" style="min-width:260px">
                            <select name="enfant" onchange="this.form.submit()">
                                {% for k in kids %}
                                    <option value="{{ k.id }}" {{ k.id==current.id ? 'selected' }}>
                                        {{ k.firstName }} {{ k.lastName }} ‚Äî {{ k.level ?? '' }}
                                    </option>
                                {% endfor %}
                            </select>
                            <span>Enfant</span>
                        </label>
                        <input type="hidden" name="tab" value="{{ tab }}">
                        <noscript><button class="btn">Voir</button></noscript>
                    </form>

                    <div class="kpi-circles">
                   
                        <div class="circle" style="--p: {{ data.presencePct30|default(0) }};" data-val="{{ data.presencePct30|default(0) }}">
                            <b>{{ data.presentCount30|default(0) }}</b>
                            <span>Pr√©sences</span>
                        </div>


                        <div class="circle" style="--p: {{ data.absencePct30|default(0) }};" data-val="{{ data.absencePct30|default(0) }}">
                            <b>{{ data.absentCount30|default(0) }}</b>
                            <span>Absences</span>
                        </div>


                        <div class="circle" style="--p: {{ data.signedRate|default(0) }};" data-val="{{ data.signedRate|default(0) }}">
                            <b>{{ data.signedCount|default(0) }}/{{ data.totalUpcoming|default(0) }}</b>
                            <span>Sorties</span>
                        </div>
                    </div>

                </aside>
            </div>
        </section>

        <section class="section tabs">
            <div class="container">
                <nav class="tabs-nav" aria-label="Sections">
                    <a class="{{ tab=='overview'  ? 'active' }}" href="{{ path('app_account', {enfant: current.id, tab:'overview'}) }}">Vue d‚Äôensemble</a>
                    <a class="{{ tab=='presences' ? 'active' }}" href="{{ path('app_account', {enfant: current.id, tab:'presences'}) }}">Pr√©sences</a>
                    <a class="{{ tab=='sorties'   ? 'active' }}" href="{{ path('app_account', {enfant: current.id, tab:'sorties'}) }}">Sorties</a>
                    <a class="{{ tab=='messages'  ? 'active' }}" href="{{ path('app_account', {enfant: current.id, tab:'messages'}) }}">Messages</a>
                    <a class="{{ tab=='settings'  ? 'active' }}" href="{{ path('app_account', {enfant: current.id, tab:'settings'}) }}">Param√®tres</a>
                </nav>
            </div>
        </section>

        <section class="section">
            <div class="container">

                {# ===== OVERVIEW ===== #}
                {% if tab == 'overview' %}
                    <div class="grid-3">
                        <article class="card">
                            <div class="card-head"><b>Prochaine s√©ance</b></div>
                            <p>Samedi prochain ‚Äî pr√©sence pr√©vue :
                                <span class="badge ghost">{{ (data.presenceRate30 ?? 0) >= 50 ? 'Plut√¥t pr√©sent' : 'Plut√¥t absent' }}</span>
                            </p>
                            <p class="muted">Maison des associations ‚Äî Stains</p>
                        </article>


                        <article class="card">
                            <div class="card-head"><b>Sorties √† venir</b></div>
                            <ul class="clean">
                                {% set up3 = data.upcoming|slice(0,3) %}
                                {% if up3 is not empty %}
                                    {% for r in up3 %}
                                        <li>{{ r.outing.startsAt|date('d/m') }} ‚Äî {{ r.outing.title }}</li>
                                    {% endfor %}
                                {% else %}
                                    <li class="muted">Aucune sortie programm√©e.</li>
                                {% endif %}
                            </ul>
                            <div class="actions">
                                <a class="btn ghost" href="{{ path('app_account', {enfant: current.id, tab:'sorties'}) }}">Voir les sorties</a>
                            </div>
                        </article>
                    </div>
                {% endif %}

                {# ===== PRESENCES ‚Äî calendrier serveur (m√™mes √©l√©ments visuels) ===== #}
                {% if tab == 'presences' and data.cal %}
                    <div class="panel-head">
                        <h2>Pr√©sences ‚Äî Calendrier</h2>
                        <p class="muted">Lecture seule ‚Äî les statuts sont saisis par l‚Äô√©quipe Stains Espoir.</p>
                    </div>

                    <form method="get" action="{{ path('app_account') }}" class="row" style="gap:10px;align-items:center;margin-bottom:12px">
                        <input type="hidden" name="enfant" value="{{ current.id }}">
                        <input type="hidden" name="tab" value="presences">
                        <label class="fgroup floating">
                            {% set y = data.schoolYear %}
                            <select name="annee" onchange="this.form.submit()">
                                {% for yy in [y-1, y, y+1] %}
                                    <option value="{{ yy }}" {{ yy==y ? 'selected' }}>{{ yy }}‚Äì{{ yy+1 }}</option>
                                {% endfor %}
                            </select>
                            <span>Ann√©e scolaire</span>
                        </label>
                        <noscript><button class="btn">Aller</button></noscript>
                    </form>

                    <div class="card cal">
                        <div class="cal-head">
                            {# fl√®ches server-side, clamp√©es √† l‚Äôann√©e scolaire #}
                            {% if data.cal.prev %}
                                <a class="btn cal-prev" href="{{ path('app_account', { enfant: current.id, tab: 'presences', annee: data.schoolYear, mois: data.cal.prev }) }}" aria-label="Mois pr√©c√©dent">‚Üê</a>
                            {% else %}
                                <span class="btn cal-prev" aria-disabled="true">‚Üê</span>
                            {% endif %}

                            <div class="cal-title">{{ data.cal.label|capitalize }}</div>

                            {% if data.cal.next %}
                                <a class="btn cal-next" href="{{ path('app_account', { enfant: current.id, tab: 'presences', annee: data.schoolYear, mois: data.cal.next }) }}" aria-label="Mois suivant">‚Üí</a>
                            {% else %}
                                <span class="btn cal-next" aria-disabled="true">‚Üí</span>
                            {% endif %}
                        </div>

                        <div class="cal-grid" aria-label="Calendrier mensuel">
                            {% set dayNames = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'] %}
                            {% for name in dayNames %}
                                <div class="cal-dayname">{{ name }}</div>
                            {% endfor %}

                            {% for i in 1..data.cal.startPad %}
                                <div class="cal-cell empty"></div>
                            {% endfor %}

                            {% for d in data.cal.days %}
                                <div class="cal-cell {{ d.isSaturday ? 'sat' }}">
                                    <div class="cal-num">{{ d.d }}</div>
                                    {% if d.isSaturday %}
                                        {% set st = d.status %}
                                        {% set label = st == 'present' ? 'Pr√©sent' : (st == 'absent' ? 'Absent' : (st in ['late','excused'] ? '√Ä confirmer' : '‚Äî')) %}
                                        {% set cls   = st == 'present' ? 'yes'     : (st == 'absent' ? 'no'     : (st in ['late','excused'] ? 'maybe'       : 'none')) %}
                                        <div class="cal-status {{ cls }}">{{ label }}</div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>

                        <div class="legend">
                            <span class="dot yes"></span> Pr√©sent
                            <span class="dot no"></span> Absent
                            <span class="dot maybe"></span> √Ä confirmer
                            <span class="dot none"></span> Non programm√©
                        </div>
                    </div>
                {% endif %}

                {# ===== SORTIES (sans JS n√©cessaire) ===== #}
                {% if tab == 'sorties' %}
                    <div class="panel-head">
                        <h2>Sorties</h2>
                        <p class="muted">Autorisations parentales (lecture c√¥t√© parent, envoi depuis le bouton).</p>
                    </div>

                    <div class="out-grid">
                        {% if data.upcoming is empty %}
                            <p class="muted">Aucune sortie planifi√©e.</p>
                        {% endif %}

                        {% for r in data.upcoming %}
                            {% set signed = r.signedAt or r.status in ['confirmed','attended'] %}
                            <article class="out-ticket">
                                {% if r.outing.imageUrl %}
                                    <img src="{{ r.outing.imageUrl }}" alt="Image ‚Äî {{ r.outing.title }}" class="ticket-cover">
                                {% endif %}
                                <div class="ribbon">Sortie</div>
                                <div class="t-head">
                                    <h3>{{ r.outing.title }}</h3>
                                    <div class="t-date">{{ r.outing.startsAt|date('d/m/Y') }} ¬∑ 10h‚Äì12h</div>
                                </div>
                                <div class="t-meta">{{ r.outing.location }}</div>
                                <div class="out-actions">
                                    {% if signed %}
                                        <span class="badge ok">Sign√©e</span>
                                    {% else %}
                                        {# ‚úÖ Lien serveur vers la page de signature (marche m√™me sans JS) #}
                                        <a class="btn ghost" href="{{ path('app_account_outing_sign_form', { id: r.id }) }}">Autoriser la sortie</a>
                                    {% endif %}
                                </div>
                            </article>
                        {% endfor %}
                    </div>

                    {% if data.past is not empty %}
                        <h3 style="margin-top:24px">Sorties pass√©es</h3>

                        <div class="past-grid">
                            {% for r in data.past %}
                                {% set o = r.outing %}
                                {# image externe (http/https//) ou chemin local via asset(); sinon pas d'image #}
                                {% set cover = null %}
                                {% if o.imageUrl is defined and o.imageUrl %}
                                    {% set isExternal = o.imageUrl starts with 'http://' or o.imageUrl starts with 'https://' or o.imageUrl starts with '//' %}
                                    {% set cover = isExternal ? o.imageUrl : asset(o.imageUrl) %}
                                {% endif %}

                                {% set st = r.status|default('') %}
                                {% set stLabel = {
                                    'attended':'Pr√©sent',
                                    'absent':'Absent',
                                    'confirmed':'Sign√©e',
                                    'declined':'Refus√©e',
                                    'cancelled':'Annul√©e'
                                }[st]|default(st) %}
                                {% set stClass = {
                                    'attended':'ok',
                                    'confirmed':'ok',
                                    'absent':'no',
                                    'declined':'no',
                                    'cancelled':'warn'
                                }[st]|default('ghost') %}

                                <article class="card past-card {{ cover ? '' : 'noimg' }}">
                                    {% if cover %}
                                        <div class="pc-media">
                                            <img src="{{ cover }}" alt="Image ‚Äî {{ o.title }}">
                                        </div>
                                    {% endif %}

                                    <div class="pc-body">
                                        <div class="pc-head">
                                            <div class="pc-date">{{ o.startsAt|date('d/m/Y') }}</div>
                                            <span class="badge {{ stClass }}">{{ stLabel }}</span>
                                        </div>

                                        <h4 class="pc-title">{{ o.title }}</h4>
                                        {% if o.location %}
                                            <div class="pc-loc muted">{{ o.location }}</div>
                                        {% endif %}

                                        {% if o.description is defined and o.description %}
                                            {% set plain = o.description|striptags %}
                                            <p class="pc-desc">{{ plain|length > 220 ? plain|slice(0,220) ~ '‚Ä¶' : plain }}</p>
                                        {% endif %}

                                        {% if r.signedAt %}
                                            <div class="pc-meta muted">Autorisation sign√©e le {{ r.signedAt|date('d/m/Y') }}</div>
                                        {% endif %}
                                    </div>
                                </article>
                            {% endfor %}
                        </div>
                    {% endif %}

                {% endif %}

                {# ===== MESSAGES ===== #}
                {% if tab == 'messages' %}
                    {% for label, msgs in app.flashes %}
                        {% for m in msgs %}
                            <div class="flash {{ label }}">{{ m }}</div>
                        {% endfor %}
                    {% endfor %}

                    <div class="msg-layout">
                        <div id="msgList" class="card msg-list" style="max-height:420px;overflow:auto">
                            {% if data.messages is empty %}
                                <p class="muted" style="margin:0">Aucun message.</p>
                            {% else %}
                                {% for m in data.messages %}
                                    <div class="msg {{ m.from == 'staff' ? 'left' : 'right' }}">
                                        <div class="bubble">{{ m.body }}</div>
                                        <div class="when">
                                            {{ m.createdAt|date('d/m/Y H:i') }}{% if not m.readAt %} ¬∑ <span class="badge warn">Non lu</span>{% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <form class="card msg-compose" method="post" action="{{ path('app_account_message_send') }}">
                            <input type="hidden" name="_token" value="{{ csrf_token('send_message') }}">
                            <input type="hidden" name="child_id" value="{{ current.id }}">
                            <label class="fgroup floating wide">
                                <textarea name="text" rows="3" placeholder=" " required></textarea>
                                <span>Votre message‚Ä¶</span>
                            </label>
                            <div class="actions">
                                <button class="btn" type="submit">Envoyer</button>
                            </div>
                        </form>
                    </div>
                {% endif %}

                {# ===== PARAMETRES ===== #}
                {% if tab == 'settings' %}
                    <div class="grid-2">
                        <div class="card">
                            <b>Profil parent</b>
                            <div class="grid-2">
                                <div><div class="muted">Pr√©nom</div><div><b>{{ app.user.profile.firstName }}</b></div></div>
                                <div><div class="muted">Nom</div><div><b>{{ app.user.profile.lastName }}</b></div></div>
                                <div><div class="muted">Email</div><div>{{ app.user.email }}</div></div>
                                <div><div class="muted">T√©l√©phone</div><div>{{ app.user.profile.phone }}</div></div>
                            </div>
                        </div>
                        <div class="card">
                            <b>Enfants rattach√©s</b>
                            <div class="kid-mini-list">
                                {% for k in kids %}
                                    <div class="kid-mini"><b>{{ k.firstName }} {{ k.lastName }}</b> ‚Äî {{ k.level ?? '' }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}

            </div>
        </section>
    </main>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        // Messages : ancrer le scroll en bas (optionnel)
        (function(){ var box=document.getElementById('msgList'); if(box) box.scrollTop=box.scrollHeight; })();
    </script>
{% endblock %}
