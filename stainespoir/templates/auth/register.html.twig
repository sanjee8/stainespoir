{# templates/auth/register.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Inscription parent ‚Äî Stains Espoir{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        :root{
            --brand:#6A1B9A; --ink:#111; --muted:#667085; --bg:#fff;
            --radius:16px; --shadow:0 10px 30px rgba(20,20,43,.08); --ring:0 0 0 3px rgba(106,27,154,.15);
            --pill:#f5ecff; --line:#eef0f3;
        }
        .auth-hero{padding:56px 0;background:linear-gradient(180deg,#fff,#fafaff)}
        .auth-hero .pill{display:inline-block;background:var(--pill);color:var(--brand);padding:.5rem .75rem;border-radius:999px;font-weight:600}
        .auth-hero h1{margin:.5rem 0 0;font-size:clamp(26px,4vw,34px)}
        .auth-hero .lead{margin:.35rem 0 0;color:var(--muted)}

        .section{padding:28px 0}
        .card{background:#fff;border:1px solid #eee;border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}

        /* Wizard */
        .wizard{display:flex; gap:10px; list-style:none; padding:0; margin:0 0 16px}
        .wizard li{flex:1; display:flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; color:#6b7280}
        .wizard li span{display:inline-grid; place-items:center; width:26px; height:26px; border-radius:50%; background:#f1f1fb; color:#333; font-weight:700}
        .wizard li em{font-style:normal; font-weight:600}
        .wizard li.active{border-color:#e6daf8; color:#3a3a3a}
        .wizard li.active span{background:var(--pill); color:var(--brand)}
        .wizard li.current{box-shadow:var(--ring); border-color:var(--brand); color:#111}
        .wizard li.current span{background:var(--brand); color:#fff}

        /* Grids + boutons */
        .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
        .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
        .actions{display:flex;gap:10px;justify-content:space-between;margin-top:14px}
        .right{margin-left:auto}
        .btn{display:inline-block;border:1px solid #d9dce0;padding:12px 18px;border-radius:12px;background:#fff;cursor:pointer;text-decoration:none}
        .btn:hover{box-shadow:var(--shadow)}
        .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
        .btn.ghost{background:#fff}
        .btn.danger{background:#fff;border-color:#dc2626;color:#dc2626}

        /* Champs flottants */
        .fgroup{position:relative; display:block}
        .fgroup input,.fgroup select,.fgroup textarea{
            width:100%; padding:14px 12px; border:1px solid #e3e6ea; border-radius:12px; font:inherit; background:#fff; min-width:0;
        }
        .fgroup input:focus,.fgroup select:focus,.fgroup textarea:focus{outline:none; box-shadow:var(--ring); border-color:#c9b0ee}
        .fgroup.floating > span{
            position:absolute; left:12px; top:12px; color:#8a8fa0; pointer-events:none; transition:all .16s ease;
            background:#fff; padding:0 6px; transform-origin:left top;
        }
        .fgroup.floating input:not(:placeholder-shown) + span,
        .fgroup.floating input:focus + span,
        .fgroup.floating select:focus + span,
        .fgroup.floating textarea:not(:placeholder-shown) + span,
        .fgroup.floating textarea:focus + span{
            transform:translateY(-20px) scale(.85); color:#6A1B9A;
        }
        .fgroup.floating input::placeholder, .fgroup.floating textarea::placeholder{color:transparent}
        .hint{display:block; color:#8b90a3; font-size:.9rem; margin-top:6px}

        /* Password meter + show/hide */
        .password{position:relative}
        .showpass{position:absolute; right:10px; top:10px; border:0; background:transparent; cursor:pointer}
        .meter{position:relative; height:6px; background:#eef0f6; border-radius:999px; margin-top:8px; overflow:hidden}
        .meter i{position:absolute; inset:0; transform-origin:left; transform:scaleX(var(--p,0)); background:linear-gradient(90deg,#ff6a6a,#ffe16a,#60c173);}

        /* Kids */
        .kids{display:grid; gap:14px}
        .kid.card{padding:16px}
        .kid-actions{display:flex; justify-content:flex-end; margin-top:8px}
        #btnAddKid{ margin-bottom:14px; } /* espace sous le bouton */

        /* R√©cap */
        .recap-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
        .recap-card{border:1px solid #eee;border-radius:12px;padding:12px;background:#fff}
        .recap-card h4{margin:0 0 6px;font-size:1rem}
        .kid-mini{border-top:1px dashed #eee; padding-top:6px; margin-top:6px}
        .form-msg{min-height:22px;margin-top:8px;color:#b91c1c}

        /* Utils */
        .hidden{display:none}
        .muted{color:var(--muted)}

        /* Mobile optimisations */
        @media (max-width: 900px){
            .wizard{flex-direction:column}
            .grid-2,.grid-3{grid-template-columns:1fr;gap:16px}
            .card{padding:18px}
        }
        @media (max-width: 600px){
            .auth-hero{padding:42px 0}
            .grid-2,.grid-3{gap:18px}
            .card{padding:16px}
            .fgroup input,.fgroup select,.fgroup textarea{padding:16px 14px; font-size:16px;} /* anti-zoom iOS & plus d‚Äôair */
            .actions{flex-wrap:wrap; gap:12px}
            #btnAddKid{width:100%}
        }
    </style>
{% endblock %}

{% block body %}
    <section class="auth-hero">
        <div class="container">
            <span class="pill">üë®‚Äçüë©‚Äçüëß Espace parents</span>
            <h1>Cr√©er mon compte parent</h1>
            <p class="lead">Un seul compte pour suivre l‚Äô√©volution de vos enfant(s) tout au long de l‚Äôann√©e.</p>
        </div>
    </section>

    <section class="section" id="formSection">
        <div class="container">
            <ol class="wizard" aria-label="Progression">
                <li class="active current" data-step="0"><span>1</span><em>Compte</em></li>
                <li data-step="1"><span>2</span><em>Parent</em></li>
                <li data-step="2"><span>3</span><em>Enfant(s)</em></li>
                <li data-step="3"><span>4</span><em>R√©cap</em></li>
            </ol>

            <form id="registerForm" novalidate data-endpoint="{{ path('app_register_submit') }}">
                <input type="hidden" id="csrfField" value="{{ csrf_token }}">

                {# STEP 1 ‚Äî Compte #}
                <section class="card step-pane step-pane-1">
                    <h2>Informations de connexion</h2>
                    <div class="grid-2">
                        <label class="fgroup floating">
                            <input type="email" id="su_email" required autocomplete="email" placeholder=" ">
                            <span>Email</span>
                        </label>

                        <label class="fgroup floating password">
                            <input type="password" id="su_password" required minlength="8" autocomplete="new-password" placeholder=" ">
                            <span>Mot de passe</span>
                            <button class="showpass" type="button" aria-label="Afficher/masquer le mot de passe">üëÅÔ∏è</button>
                            <div class="meter" aria-hidden="true"><i></i></div>
                            <small class="hint">8+ caract√®res, 1 majuscule, 1 chiffre, 1 symbole</small>
                        </label>

                        <label class="fgroup floating password">
                            <input type="password" id="su_confirm" required autocomplete="new-password" placeholder=" ">
                            <span>Confirmer le mot de passe</span>
                            <button class="showpass" type="button" aria-label="Afficher/masquer le mot de passe">üëÅÔ∏è</button>
                        </label>

                        <label class="fgroup floating">
                            <input type="tel" id="su_parent_tel" placeholder=" ">
                            <span>T√©l√©phone (contact)</span>
                        </label>
                    </div>

                    <div class="actions">
                        <span class="muted">D√©j√† un compte ? <a href="{{ path('app_login') }}">Se connecter</a></span>
                        <button class="btn primary right" type="button" id="btnNext">Continuer ‚Üí</button>
                    </div>
                </section>

                {# STEP 2 ‚Äî Parent #}
                <section class="card step-pane step-pane-2 hidden">
                    <h2>Informations du parent / tuteur</h2>
                    <div class="grid-2">
                        <label class="fgroup floating">
                            <input type="text" id="su_parent_prenom" required placeholder=" ">
                            <span>Pr√©nom</span>
                        </label>
                        <label class="fgroup floating">
                            <input type="text" id="su_parent_nom" required placeholder=" ">
                            <span>Nom</span>
                        </label>
                        <label class="fgroup floating">
                            <select id="su_lien" required>
                                <option value="" selected disabled>Choisir‚Ä¶</option>
                                <option>P√®re</option><option>M√®re</option><option>Tuteur / Tutrice</option><option>Autre</option>
                            </select>
                            <span>Lien avec l‚Äôenfant</span>
                        </label>
                        <label class="fgroup floating">
                            <input type="text" id="su_adresse" placeholder=" ">
                            <span>Adresse</span>
                        </label>
                        <label class="fgroup floating">
                            <input type="text" id="su_cp" placeholder=" ">
                            <span>Code postal</span>
                        </label>
                        <label class="fgroup floating">
                            <input type="text" id="su_ville" placeholder=" ">
                            <span>Ville</span>
                        </label>
                    </div>

                    <div class="actions">
                        <button class="btn ghost" type="button" id="btnPrev">‚Üê Pr√©c√©dent</button>
                        <button class="btn primary right" type="button" id="btnNext2">Continuer ‚Üí</button>
                    </div>
                </section>

                {# STEP 3 ‚Äî Enfant(s) #}
                <section class="card step-pane step-pane-3 hidden">
                    <div class="actions" style="margin-top:0">
                        <h2 style="margin:0">Enfant(s)</h2>
                        <button class="btn" type="button" id="btnAddKid">+ Ajouter un enfant</button>
                    </div>

                    <div id="kidsList" class="kids"></div>
                    <p class="muted">Ajoutez au moins un enfant (niveau scolaire requis).</p>

                    <div class="actions">
                        <button class="btn ghost" type="button" id="btnPrev2">‚Üê Pr√©c√©dent</button>
                        <button class="btn primary right" type="button" id="btnNext3">Continuer ‚Üí</button>
                    </div>
                </section>

                {# STEP 4 ‚Äî R√©cap + consentements #}
                <section class="card step-pane step-pane-4 hidden">
                    <h2>R√©capitulatif</h2>
                    <div id="recap" class="recap-grid" style="margin-bottom:14px;"></div>

                    <h2>Consentements</h2>
                    <div class="fgroup">
                        <label class="check"><input type="checkbox" id="consent_rgpd" required> J‚Äôaccepte le traitement de mes donn√©es (RGPD) dans le cadre de l‚Äôaccompagnement.</label>
                    </div>
                    <div class="fgroup" style="margin-top:6px">
                        <label class="check"><input type="checkbox" id="consent_photo"> J‚Äôautorise l‚Äôutilisation d‚Äôimages des activit√©s (optionnel).</label>
                    </div>

                    <div class="actions">
                        <button class="btn ghost" type="button" id="btnPrev3">‚Üê Pr√©c√©dent</button>
                        <button class="btn primary right" type="submit" id="btnSubmit">Cr√©er mon compte</button>
                    </div>
                </section>

                <p class="form-msg" id="formMsg" role="status" aria-live="polite"></p>
            </form>
        </div>
    </section>

    {# Success card #}
    <section class="section success" id="successBlock" hidden>
        <div class="container">
            <div class="card" style="max-width:680px; margin:0 auto; text-align:center">
                <div style="font-size:48px" aria-hidden="true">üéâ</div>
                <h2>Compte cr√©√© !</h2>
                <p>Bienvenue dans l‚Äôespace parents. Vous pourrez suivre l‚Äôassiduit√©, les objectifs et les sorties de votre(vos) enfant(s).</p>
                <div class="actions" style="justify-content:center">
                    <a href="{{ path('app_login') }}" class="btn">Se connecter</a>
                    <a href="{{ path('app_home') }}" class="btn ghost">Retour √† l‚Äôaccueil</a>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <meta name="turbo-visit-control" content="reload">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="register-endpoint" content="{{ path('app_register_submit') }}">

    <meta name="csrf-token" content="{{ csrf_token('register_json') }}">
    <script defer data-turbo-track="reload" src="{{ asset('js/register.js') }}"></script>
{% endblock %}
